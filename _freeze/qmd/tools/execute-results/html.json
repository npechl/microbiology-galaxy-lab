{
  "hash": "378ec79d38ce3503df9cf6c63e590b93",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Galaxy Tool Suites\"\nexecute:\n    eval: true\n    warning: false\nformat:\n  html:\n    fig-width: 14\n    fig-height: 16\n---\n\n\n\n\n\n## Load `libraries` \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# install.packages(\"data.table\")\nlibrary(data.table)\n# install.packages(\"stringr\")\nlibrary(stringr)\n\n# install.packages(c(\"ggplot2\", \"ggrepel\", \"ggtext\", \"ggh4x\"))\nlibrary(ggplot2)\nlibrary(ggrepel)\nlibrary(ggtext)\nlibrary(ggh4x)\n\n# install.packages(c(\"extrafont\", \"paletteer\", \"colorspace\"))\nlibrary(extrafont)\nlibrary(paletteer)\nlibrary(colorspace)\n```\n:::\n\n\n\n\n\n## Load input dataset \n\n\n\n\n\n\n\n\n\n\n\n## Tool Availability graph: Heatmap \n\n### Extract availability information\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindex <- tools_dt |> colnames() |> str_subset(\"Number of tools on\")\n\navailability <- tools_dt[, c(\"Suite ID\", \"EDAM reduced topics\", index), with = FALSE] |> unique()\n\ncolnames(availability) <- availability |> \n    colnames() |> \n    str_remove_all(\"Number\\\\ of\\\\ tools\\\\ on\") |> \n    str_squish()\n```\n:::\n\n\n\n\n\n### Filter out duplicates\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindex <- which(availability$`Suite ID` == \"srst2\" & availability$`EDAM reduced topics` == \"\")\n\navailability <- availability[-index]\n```\n:::\n\n\n\n\n\n### Hierarchical clustering\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmm <- availability[, -c(1, 2)] |> as.matrix(rownames = availability$`Suite ID`)\n\nmm_c <- mm |> dist(method = \"manhattan\") |> hclust(method = \"ward.D2\")\nmm_r <- t(mm) |> dist(method = \"manhattan\") |> hclust(method = \"ward.D2\")\n```\n:::\n\n\n\n\n\n### Construct plotting data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- availability |> melt(id.vars = c(\"Suite ID\", \"EDAM reduced topics\"), variable.factor = FALSE, value.factor = FALSE)\nd <- d[which(value >= 1)]\n\nd$`Suite ID` <- d$`Suite ID` |> factor(levels = mm_c$labels[mm_c$order |> rev()])\nd$variable   <- d$variable |> factor(levels = mm_r$labels[mm_r$order |> rev()])\n\nd$fct <- ifelse(d$variable |> str_detect(\"UseGalaxy\"), \"UseGalaxy\", \"vOther\")\n\nindex <- d[which(fct == \"UseGalaxy\")][[1]] |> unique()\n\np  <- d[which(`Suite ID` %in% index)]\np2 <- p |> tidyr::separate_rows(\"EDAM reduced topics\", sep = \",\") |> setDT()\n\np2$`EDAM reduced topics` <- p2$`EDAM reduced topics` |> str_squish()\np2$`EDAM reduced topics` <- p2$`EDAM reduced topics` |> str_wrap(width = 10)\n\nt <- p2[, by = \"EDAM reduced topics\", .(N = `Suite ID` |> unique() |> length())]\nt <- t[order(-N)]\nt <- t[which(`EDAM reduced topics` != \"\"), head(.SD, 5)]\n\np2$edam_clean <- ifelse(p2$`EDAM reduced topics` %in% t$`EDAM reduced topics`, p2$`EDAM reduced topics`, \"Other\")\np2$edam_clean <- p2$edam_clean |> factor(levels = c(t$`EDAM reduced topics`, \"Other\"))\n```\n:::\n\n\n\n\n\n### Heatmap: Top 5 EDAM Operations\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nc_1 <- p2[which(edam_clean != \"Other\")] |> \n    \n    ggplot(aes(variable, `Suite ID`)) + \n    \n    geom_tile(aes(fill = value), color = \"grey\") + \n    \n    scale_fill_stepsn(\n        colors = c('#00429d', '#5681b9', '#93c4d2', '#ffffe0', '#ffa59e', '#dd4c65', '#93003a'),\n        guide = guide_colorsteps(barwidth = unit(14, \"lines\"), barheight = unit(.35, \"lines\")),\n        breaks = c(2, 4, 8, 16, 32, 64, 128),\n        transform = \"log2\"\n    ) +\n    \n    facet_grid(cols = vars(fct), rows = vars(edam_clean), scales = \"free\", space = \"free\") +\n    \n    scale_y_discrete(expand = c(0, 0)) +\n    scale_x_discrete(expand = c(0, 0)) +\n    \n    theme_minimal(base_family = \"Calibri\") +\n    \n    theme(\n        legend.position = \"bottom\",\n        legend.title.position = \"top\",\n        \n        axis.text.x = element_text(angle = 45, hjust = 1),\n        axis.text.y = element_text(size = 6),\n        \n        axis.title.x = element_markdown(),\n        \n        panel.border = element_rect(fill = NA, color = \"grey25\"),\n        axis.ticks.x = element_line(lineend = \"round\", color = \"grey25\"),\n        \n        strip.text.x = element_blank(),\n        strip.text.y = element_text(face = \"bold\", angle = 0, hjust = 0),\n        \n        panel.grid.minor = element_blank(),\n        panel.grid.major = element_line(linetype = \"dashed\", lineend = \"round\", linewidth = .25),\n        \n        plot.margin = margin(10, 10, 10, 10)\n    ) +\n    \n    labs(y = \"Galaxy Tool Suites\", x = \"Availability of Tool Suites Across **Servers**\", fill = \"No. of Tools\")\n```\n:::\n\n\n\n\n\n## EDAM operation: Scatter plot \n\n### Split EDAM operation per tool\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf2 = tools_dt |> tidyr::separate_rows(\"EDAM reduced operations\", sep = \",\") |> setDT()\n\nxvar <- \"Suite runs (last 5 years) on main servers\"\nyvar <- \"Suite users (last 5 years) on main servers\"\n    \ndf2$runs  <- df2[[ xvar ]]\ndf2$users <- df2[[ yvar ]]\n```\n:::\n\n\n\n\n\n### Remove empty tools\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf2 = df2[which(runs != 0 & users != 0)]\n```\n:::\n\n\n\n\n\n### Clean `EDAM operation (no superclasses)` column\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf2$`EDAM reduced operations` = df2$`EDAM reduced operations` |> str_squish()\ndf2$`EDAM reduced operations` = ifelse(df2$`EDAM reduced operations` == \"\", \"No Operation\", df2$`EDAM reduced operations`)\n```\n:::\n\n\n\n\n\n### Find most top EDAM operations\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst = df2[, by = `EDAM reduced operations`, .(N = `Suite ID` |> unique() |> length())]\nst = st[order(-N)]\nst = st[which(`EDAM reduced operations` != \"No Operation\")]\n\ndf2$`EDAM reduced operations` <- df2$`EDAM reduced operations` |> factor(levels = c(st$`EDAM reduced operations`, \"No Operation\"))\n\ndf2 <- df2[order(`Suite ID`, -`EDAM reduced operations`)]\ndf2 <- df2[, by = `Suite ID`, head(.SD, 1)]\n```\n:::\n\n\n\n\n\n### Keep only necessary columns\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf2 = df2[, c(\"Suite ID\", \"runs\", \"users\", \"EDAM reduced operations\")] |> unique()\n```\n:::\n\n\n\n\n\n### Define factor levels of cluster column\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nst <- st[1:12]\n\ndf2$cluster <- ifelse(df2$`EDAM reduced operations` %in% st$`EDAM reduced operations`, df2$`EDAM reduced operations` |> as.character(), \"Other\")\ndf2$cluster <- df2$cluster |> factor(levels = c(st$`EDAM reduced operations`, \"Other\"))\n```\n:::\n\n\n\n\n\n### gather highlighting Galaxy wrapper tools for plotting\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf2 <- df2[order(-runs, -users)]\nhg0 <- df2[1:15]\n```\n:::\n\n\n\n\n\n### create graph\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nncolors <- df2$cluster |> unique() |> length()\n\nxvar <- xvar |> str_replace(\"Suite runs\", \"**Suite runs**\")\nyvar <- yvar |> str_replace(\"Suite users\", \"**Suite users**\")\n\na <- df2 |>\n    \n    ggplot(aes(runs, users)) +\n    \n    geom_point(\n        shape = 21, size = 2, stroke = .25, \n        aes(fill = cluster, color = cluster)\n    ) +\n    \n    geom_text_repel(\n        data = hg0, aes(label = `Suite ID`),\n        bg.r = .05, bg.color = \"grey96\", fontface = \"bold\", family = \"Calibri\", box.padding = .5,\n        segment.size = .3, max.overlaps = Inf, size = 3\n    ) +\n    \n    scale_x_continuous(\n        trans = \"log10\",  # expand = c(0, 0), \n        limits = c(1, 10000000), \n        breaks = scales::trans_breaks(\"log10\", function(x) 10^x),\n        labels = scales::trans_format(\"log10\", scales::math_format(10^.x))\n    ) +\n    \n    scale_y_continuous(\n        trans = \"log10\", # limits = c(1, 10000),\n        labels = scales::comma, # expand = c(0, 0), \n        breaks = c(.1, 1, 10, 100, 1000, 10000)\n    ) +\n    \n    scale_fill_manual(values = c(paletteer_d(\"ggsci::default_igv\", ncolors - 1), \"grey\") |> lighten(.25), guide = guide_legend(nrow = 4, override.aes = list(size = 2.5))) +\n    scale_color_manual(values = c(paletteer_d(\"ggsci::default_igv\", ncolors - 1), \"grey\") |> darken(.25), guide = \"none\") +\n    \n    coord_cartesian() +\n    \n    theme_minimal(base_family = \"Calibri\") +\n    \n    theme(\n        legend.position = \"bottom\",\n        legend.title.position = \"top\",\n        legend.justification = \"left\",\n        \n        strip.text = element_markdown(),\n        \n        axis.title.x = element_markdown(margin = margin(t = 10)),\n        axis.title.y = element_markdown(margin = margin(r = 10)),\n        \n        # axis.ticks = element_line(linewidth = .3),\n        panel.grid.major = element_line(linewidth = .3, linetype = \"dashed\", lineend = \"round\", color = \"grey75\"),\n        \n        # panel.border = element_rect(linewidth = .3, fill = NA),\n        \n        axis.line = element_line(lineend = \"round\"),\n        axis.ticks = element_line(lineend = \"round\")\n    ) +\n    \n    labs(x = xvar, y = yvar, fill = \"EDAM operation\")\n```\n:::\n\n\n\n\n\n## No. of Tool Suites over time \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd1 <- tools_dt[order(`Suite first commit date`)]\n\nd1$ypos <- seq_along(d1$`Suite first commit date`)\n\nd1$year <- d1$`Suite first commit date` |> lubridate::year()\n\nd2 <- d1[, by = year, .(N = max(ypos))]\n\nd2$year <- paste0(d2$year, \"-01-01\") |> lubridate::as_date()\n\nd1_p <- d1 |>\n    ggplot(aes(`Suite first commit date`, ypos)) +\n    geom_line(linewidth = .45, color = \"#3C3C3C\") +\n    geom_area(alpha = .25) +\n    \n    # geom_point(data = d2, aes(year, N)) +\n    scale_x_date(expand = c(0.01, 0.01)) +\n    scale_y_continuous(expand = c(0, 0), breaks = seq(50, 300, by = 50), limits = c(0, 300))+\n    theme_minimal(base_family = \"Calibri\") +\n    theme(\n        # panel.grid.major = element_line(linewidth = .45, color = \"grey85\"),\n        # panel.grid.minor = element_line(linewidth = .35),\n        \n        panel.grid.major = element_line(linewidth = .3, linetype = \"dashed\", lineend = \"round\", color = \"grey75\"),\n        \n        axis.title.x = element_markdown(margin = margin(t = 10)),\n        axis.title.y = element_markdown(margin = margin(r = 10)),\n        \n        axis.line = element_line(lineend = \"round\"),\n        axis.ticks = element_line(lineend = \"round\")\n    ) +\n    labs(y = \"Cumulative number of tool suites\")\n```\n:::\n\n\n\n\n\n## Patchwork \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(patchwork)\n\nmulti <- (free(c_1) | (a / d1_p)) + \n    plot_layout(widths = c(2, 1.5)) +\n    plot_annotation(tag_levels = \"A\") &\n    theme(\n        plot.tag = element_text(face = \"bold\", family = \"Calibri\", size = 25),\n        plot.background = element_rect(fill = \"transparent\", color = NA)\n    )\n\nmulti\n```\n\n::: {.cell-output-display}\n![](tools_files/figure-html/unnamed-chunk-16-1.svg)\n:::\n:::",
    "supporting": [
      "tools_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}